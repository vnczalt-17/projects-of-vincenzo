---
AWSTemplateFormatVersion: "2010-09-09"

Description: >
    This is cloudformation template for roman numerals application.
    This flask web application runs on EC2 allows connection from anywhere
    on port 80

Resources:
    MySecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: Enables HTTP for Flask Web Server
            GroupName: Flask-WS-SG
            SecurityGroupIngress: 
                -   IpProtocol: tcp
                    FromPort: 80
                    ToPort: 80
                    CidrIp: 0.0.0.0/0
                -   IpProtocol: tcp
                    FromPort: 22
                    ToPort: 22
                    CidrIp: 0.0.0.0/0 

    MyWebServer:
        Type: AWS::EC2::Instance
        Properties:
            ImageId: ami-08f3d892de259504d
            InstanceType: t2.micro
            SecurityGroupIds:
                - !Ref MySecurityGroup
            Tags:
                - 
                    Key: Name
                    Value: !Sub Web Server of ${AWS::StackName} Stack
            UserData:
                Fn::Base64:
                   !Sub |
                    #! /bin/bash
                    yum update -y
                    yum install python3 -y
                    pip3 install flask
                    wget -P templates https://raw.githubusercontent.com/vnczalt-17/projects-of-vincenzo/master/dirty_hands/templates/index.html
                    wget -P templates https://raw.githubusercontent.com/vnczalt-17/projects-of-vincenzo/master/dirty_hands/templates/result.html
                    wget https://raw.githubusercontent.com/vnczalt-17/projects-of-vincenzo/master/dirty_hands/app.py
                    python3 app.py
    myASG:
        Type: AWS::AutoScaling::AutoScalingGroup
        Properties:
            AutoScalingGroupName: myASG
            MinSize: "1"
            MaxSize: "3"
            DesiredCapacity: "2"
            HealthCheckGracePeriod: 90
            HealthCheckType: ELB
            VPCZoneIdentifier:
                - subnet-11d6244e
                - subnet-a6ebee98
                - subnet-dc4acb91
                - subnet-d7fc57d9
                - subnet-5e3bc77f
                - subnet-855caae3                    
Outputs:
    WebsiteURL:
        Description: Roman Numerals Converter Application Website URL
        Value: !Sub
            - http://${PublicAddress}
            - PublicAddress: !GetAtt MyWebServer.PublicDnsName
    